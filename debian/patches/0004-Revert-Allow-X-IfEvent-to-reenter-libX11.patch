From f5770ee16fe87d7d1ab56df38a4e07f5e73c3464 Mon Sep 17 00:00:00 2001
From: Timo Aaltonen <tjaalton@debian.org>
Date: Tue, 20 Dec 2022 16:51:30 +0200
Subject: [PATCH 4/4] Revert "Allow X*IfEvent() to reenter libX11"

This reverts commit 79775575418fd6f8ee1c5e5bbe403df4606fb5b6.
---
 include/X11/Xlibint.h |  1 -
 src/ChkIfEv.c         |  3 ---
 src/IfEvent.c         |  2 --
 src/OpenDis.c         |  1 -
 src/PeekIfEv.c        |  2 --
 src/locking.c         | 30 ------------------------------
 6 files changed, 39 deletions(-)

diff --git a/include/X11/Xlibint.h b/include/X11/Xlibint.h
index b4275ebd..cbf3aac3 100644
--- a/include/X11/Xlibint.h
+++ b/include/X11/Xlibint.h
@@ -207,7 +207,6 @@ struct _XDisplay
 
 	XIOErrorExitHandler exit_handler;
 	void *exit_handler_data;
-        Bool in_ifevent;
 };
 
 #define XAllocIDs(dpy,ids,n) (*(dpy)->idlist_alloc)(dpy,ids,n)
diff --git a/src/ChkIfEv.c b/src/ChkIfEv.c
index 327b5eaf..876a850e 100644
--- a/src/ChkIfEv.c
+++ b/src/ChkIfEv.c
@@ -50,7 +50,6 @@ Bool XCheckIfEvent (
 	int n;			/* time through count */
 
         LockDisplay(dpy);
-        dpy->in_ifevent = True;
 	prev = NULL;
 	for (n = 3; --n >= 0;) {
 	    for (qelt = prev ? prev->next : dpy->head;
@@ -61,7 +60,6 @@ Bool XCheckIfEvent (
 		    *event = qelt->event;
 		    _XDeq(dpy, prev, qelt);
 		    _XStoreEventCookie(dpy, event);
-                    dpy->in_ifevent = False;
 		    UnlockDisplay(dpy);
 		    return True;
 		}
@@ -80,7 +78,6 @@ Bool XCheckIfEvent (
 		/* another thread has snatched this event */
 		prev = NULL;
 	}
-        dpy->in_ifevent = False;
 	UnlockDisplay(dpy);
 	return False;
 }
diff --git a/src/IfEvent.c b/src/IfEvent.c
index a0aed7e3..ead93dca 100644
--- a/src/IfEvent.c
+++ b/src/IfEvent.c
@@ -49,7 +49,6 @@ XIfEvent (
 	unsigned long qe_serial = 0;
 
         LockDisplay(dpy);
-        dpy->in_ifevent = True;
 	prev = NULL;
 	while (1) {
 	    for (qelt = prev ? prev->next : dpy->head;
@@ -60,7 +59,6 @@ XIfEvent (
 		    *event = qelt->event;
 		    _XDeq(dpy, prev, qelt);
 		    _XStoreEventCookie(dpy, event);
-                    dpy->in_ifevent = False;
 		    UnlockDisplay(dpy);
 		    return 0;
 		}
diff --git a/src/OpenDis.c b/src/OpenDis.c
index e1bc2a30..5017b040 100644
--- a/src/OpenDis.c
+++ b/src/OpenDis.c
@@ -189,7 +189,6 @@ XOpenDisplay (
 	dpy->xcmisc_opcode	= 0;
 	dpy->xkb_info		= NULL;
 	dpy->exit_handler_data	= NULL;
-        dpy->in_ifevent         = False;
 
 /*
  * Setup other information in this display structure.
diff --git a/src/PeekIfEv.c b/src/PeekIfEv.c
index c4e8af0d..207cd119 100644
--- a/src/PeekIfEv.c
+++ b/src/PeekIfEv.c
@@ -50,7 +50,6 @@ XPeekIfEvent (
 	unsigned long qe_serial = 0;
 
 	LockDisplay(dpy);
-        dpy->in_ifevent = True;
 	prev = NULL;
 	while (1) {
 	    for (qelt = prev ? prev->next : dpy->head;
@@ -64,7 +63,6 @@ XPeekIfEvent (
 			_XStoreEventCookie(dpy, &copy);
 			*event = copy;
 		    }
-                    dpy->in_ifevent = False;
 		    UnlockDisplay(dpy);
 		    return 0;
 		}
diff --git a/src/locking.c b/src/locking.c
index bdc07011..3404ccc2 100644
--- a/src/locking.c
+++ b/src/locking.c
@@ -452,32 +452,6 @@ static void _XDisplayLockWait(
     }
 }
 
-static void _XLockDisplay(
-    Display *dpy
-    XTHREADS_FILE_LINE_ARGS
-    );
-
-static void _XIfEventLockDisplay(
-    Display *dpy
-    XTHREADS_FILE_LINE_ARGS
-    )
-{
-    /* assert(dpy->in_ifevent); */
-}
-
-static void _XIfEventUnlockDisplay(
-    Display *dpy
-    XTHREADS_FILE_LINE_ARGS
-    )
-{
-    if (dpy->in_ifevent)
-        return;
-
-    dpy->lock_fns->lock_display = _XLockDisplay;
-    dpy->lock_fns->unlock_display = _XUnlockDisplay;
-    UnlockDisplay(dpy);
-}
-
 static void _XLockDisplay(
     Display *dpy
     XTHREADS_FILE_LINE_ARGS
@@ -504,10 +478,6 @@ static void _XLockDisplay(
 #endif
     _XIDHandler(dpy);
     _XSeqSyncFunction(dpy);
-    if (dpy->in_ifevent) {
-        dpy->lock_fns->lock_display = _XIfEventLockDisplay;
-        dpy->lock_fns->unlock_display = _XIfEventUnlockDisplay;
-    }
 }
 
 /*
-- 
2.37.2

